<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Employee Tracker UI</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
  label, select, input, button { display: block; margin: 10px 0; }
  select, input { width: 100%; padding: 8px; }
  button { padding: 10px; }
  #results { margin-top: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
</style>
</head>
<body>

<h2>Add Employee</h2>
<form id="addEmployeeForm">
  <label>First Name: <input type="text" id="firstName" required /></label>
  <label>Middle Name: <input type="text" id="middleName" /></label>
  <label>Last Name: <input type="text" id="lastName" required /></label>
  <label>Position: <input type="text" id="position" required /></label>
  <label>Company:
    <select id="companySelect" required>
      <option value="">-- Select Company --</option>
    </select>
  </label>
  <label>Site:
    <select id="siteSelect" required>
      <option value="">-- Select Site --</option>
    </select>
  </label>
  <button type="submit">Add Employee</button>
</form>

<hr />

<h2>Remove Employee</h2>
<form id="removeEmployeeForm">
  <label>Employee ID to remove: <input type="number" id="removeId" required /></label>
  <button type="submit">Remove Employee</button>
</form>

<hr />

<h2>Retrieve Employees</h2>
<label>By Company:
  <select id="filterCompanySelect">
    <option value="">-- Select Company --</option>
  </select>
  <button id="getByCompanyBtn">Get Employees</button>
</label>

<label>By Site:
  <select id="filterSiteSelect">
    <option value="">-- Select Site --</option>
  </select>
  <button id="getBySiteBtn">Get Employees</button>
</label>

<div id="results"></div>

<script>
// Static companies and sites (must match your DB data)
const companies = [
  { id: 1, name: 'INNO' },
  { id: 2, name: 'SRLH' },
  { id: 3, name: 'CORELINK' },
  { id: 4, name: 'HBLX' },
];

const sites = [
  { id: 1, company_id: 1, name: 'Head' },
  { id: 2, company_id: 1, name: 'Koye' },
  { id: 3, company_id: 1, name: 'Kilinto' },
  { id: 4, company_id: 1, name: 'Bole Lemi' },
  { id: 5, company_id: 1, name: 'Gelan' },
  { id: 6, company_id: 1, name: 'Sebeta' },

  { id: 7, company_id: 2, name: 'Head' },
  { id: 8, company_id: 2, name: 'Debrebrihan' },

  { id: 9, company_id: 3, name: 'Head' },
  { id: 10, company_id: 3, name: 'Kilinto' },

  { id: 11, company_id: 4, name: 'Head' }
];

const apiBase = 'https://backendfw2.onrender.com';

// Populate company selects
function fillCompanySelect(selectElem) {
  selectElem.innerHTML = '<option value="">-- Select Company --</option>';
  companies.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;
    selectElem.appendChild(option);
  });
}

// Populate site select filtered by company
function fillSiteSelect(siteSelect, companyId) {
  siteSelect.innerHTML = '<option value="">-- Select Site --</option>';
  sites.filter(s => s.company_id == companyId)
       .forEach(s => {
         const option = document.createElement('option');
         option.value = s.id;
         option.textContent = s.name;
         siteSelect.appendChild(option);
       });
}

// When company changes in add employee form, update sites
document.getElementById('companySelect').addEventListener('change', function() {
  fillSiteSelect(document.getElementById('siteSelect'), this.value);
});

// When company changes in filter company, update filter sites
document.getElementById('filterCompanySelect').addEventListener('change', function() {
  fillSiteSelect(document.getElementById('filterSiteSelect'), this.value);
});

// Initialize company selects on page load
fillCompanySelect(document.getElementById('companySelect'));
fillCompanySelect(document.getElementById('filterCompanySelect'));

// Add Employee form submit
document.getElementById('addEmployeeForm').addEventListener('submit', async e => {
  e.preventDefault();

  const first_name = document.getElementById('firstName').value.trim();
  const middle_name = document.getElementById('middleName').value.trim();
  const last_name = document.getElementById('lastName').value.trim();
  const position = document.getElementById('position').value.trim();
  const company_id = parseInt(document.getElementById('companySelect').value);
  const site_id = parseInt(document.getElementById('siteSelect').value);

  if (!company_id || !site_id) {
    alert('Please select both company and site');
    return;
  }

  try {
    const res = await fetch(`${apiBase}/add-employee`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ first_name, middle_name, last_name, position, company_id, site_id })
    });
    const data = await res.json();
    if (res.ok) {
      alert('Employee added successfully');
      e.target.reset();
    } else {
      alert('Error: ' + data.detail);
    }
  } catch (err) {
    alert('Failed to add employee: ' + err.message);
  }
});

// Remove Employee form submit
document.getElementById('removeEmployeeForm').addEventListener('submit', async e => {
  e.preventDefault();
  const id = parseInt(document.getElementById('removeId').value);
  if (!id) {
    alert('Please enter a valid employee ID');
    return;
  }

  try {
    const res = await fetch(`${apiBase}/remove-employee`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await res.json();
    if (res.ok) {
      alert('Employee removed successfully');
      e.target.reset();
      clearResults();
    } else {
      alert('Error: ' + data.detail);
    }
  } catch (err) {
    alert('Failed to remove employee: ' + err.message);
  }
});

function clearResults() {
  document.getElementById('results').innerHTML = '';
}

// Display employees in table format
function displayEmployees(employees) {
  if (!employees.length) {
    document.getElementById('results').innerHTML = '<p>No employees found.</p>';
    return;
  }

  let html = '<table><thead><tr><th>ID</th><th>Full Name</th><th>Position</th><th>Company</th><th>Site</th></tr></thead><tbody>';
  employees.forEach(emp => {
    const fullName = [emp.first_name, emp.middle_name, emp.last_name].filter(Boolean).join(' ');
    html += `<tr>
      <td>${emp.id}</td>
      <td>${fullName}</td>
      <td>${emp.position}</td>
      <td>${emp.company_name}</td>
      <td>${emp.site_name}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('results').innerHTML = html;
}

// Get employees by company
document.getElementById('getByCompanyBtn').addEventListener('click', async () => {
  const companyId = parseInt(document.getElementById('filterCompanySelect').value);
  if (!companyId) {
    alert('Please select a company');
    return;
  }

  try {
    const res = await fetch(`${apiBase}/employees/by-company/${companyId}`);
    const data = await res.json();
    displayEmployees(data);
  } catch (err) {
    alert('Failed to get employees: ' + err.message);
  }
});

// Get employees by site
document.getElementById('getBySiteBtn').addEventListener('click', async () => {
  const siteId = parseInt(document.getElementById('filterSiteSelect').value);
  if (!siteId) {
    alert('Please select a site');
    return;
  }

  try {
    const res = await fetch(`${apiBase}/employees/by-site/${siteId}`);
    const data = await res.json();
    displayEmployees(data);
  } catch (err) {
    alert('Failed to get employees: ' + err.message);
  }
});
</script>
</body>
</html>
